imports:
    - { resource: "../BaseConfig/config.yml" }

services:
    gtt.workflow.marking_store.property_accessor:
        class: Symfony\Component\Workflow\MarkingStore\ScalarMarkingStore
        arguments:
            - status
    gtt.workflow.marking_store.orm.marking.store:
        class: Gtt\Bundle\WorkflowExtensionsBundle\MarkingStore\OrmPersistentMarkingStore
        arguments: ["@gtt.workflow.marking_store.property_accessor", "@doctrine"]

doctrine:
    dbal:
        default_connection:   default
        connections:
            default:
                driver:   pdo_sqlite
                path:     %kernel.cache_dir%/database.sqlite
    orm:
        auto_generate_proxy_classes: "%kernel.debug%"
        naming_strategy: doctrine.orm.naming_strategy.underscore
        auto_mapping: true

workflow:
    workflows:
        order_simple:
            marking_store:
                type: property_accessor
            supports:
                - AppBundle\Entity\Order
            places:
                - new
                - waiting_for_transportation
                - waiting_for_docs
                - at_warehouse
                - docs_ready
                - closed
                - problematic
                - abandoned
            transitions:
                process:
                    from:
                        - new
                    to:
                        - waiting_for_transportation
                        - waiting_for_docs
                transportation_to_warehouse:
                    from:
                        - waiting_for_transportation
                    to:
                        - at_warehouse
                docs_processing:
                    from:
                        - waiting_for_docs
                    to:
                        - docs_ready
                deliver:
                    from:
                        - at_warehouse
                        - docs_ready
                    to:
                        - done
                set_problematic:
                    from: [waiting_for_transportation]
                    to: [problematic]
                set_abandoned:
                    from: [waiting_for_transportation]
                    to: [abandoned]

workflow_extensions:
    workflows:
        order_simple:
            triggers:
                event:
                    order_docs_to_process.event:
                        schedule:
                            set_problematic:
                                offset: P30D
                        subject_retrieving_expression: 'event.getSubject()'
                    order_try_to_process_docs.event:
                        schedule:
                            set_abandoned:
                                offset: P5D
                        subject_retrieving_expression: 'event.getSubject()'




                        